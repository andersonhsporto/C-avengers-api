################################################################################
##############################  BINARIES  ######################################
################################################################################

NAME	 = avengers_api

NAME_CLI = logviewer

################################################################################
##############################  COMPILATION  ###################################
################################################################################

CC			=	cc
CFLAGS		=	-Wall -Wextra -g
INCLUDE		=	-I ./include
HEADER		=	./include/headers.h
HEADER_VI	= ./include/logvi.h

################################################################################
##############################  FLAGS  #########################################
################################################################################

LIBS	= -lcurl -lssl -lcrypto -DMG_ENABLE_OPENSSL -pthread -lmysqlclient
EFLAGS	= -lreadline
LIBFT	= -L ./source/libs/libft/ -lft

################################################################################
##############################  SOURCES  #######################################
################################################################################

S_FOLDER = ./source/
L_FOLDER = libs/
A_FOLDER = api/
C_FOLDER = cli/

LIB =	$(addprefix $(L_FOLDER), \
		mJson.c mongoose.c \
)

API	=	$(addprefix $(A_FOLDER), \
		avengers.c routes.c server.c utils.c mariadb.c  csv_reader.c json.c \
		route_id.c route_alias.c log.c \
)

SRC =	$(addprefix $(S_FOLDER), \
		$(LIB) $(API) \
)

CLI	=	$(addprefix $(C_FOLDER), \
		logvi.c signal.c printer.c filter.c prompt.c \
)

SRC_V =	$(addprefix $(S_FOLDER), \
		$(LIB) $(CLI)\
)

################################################################################
##############################  RULES  #########################################
################################################################################

.c.o:
	$(CC) $(CFLAGS) $(INCLUDE) -c $< -o $(<:%.c=%.o)

OBJ		= $(SRC:%.c=%.o)
OBJ_CLI = $(SRC_V:%.c=%.o)

all: $(NAME) logvi

$(NAME): $(OBJ) $(HEADER)
	rm -rf $(NAME)
	make all -C ./source/libs/libft
	$(CC) $(CFLAGS) $(OBJ) $(LIBFT) $(LIBS) -o $(NAME)

logvi: $(NAME_CLI)

$(NAME_CLI): $(OBJ_CLI) $(HEADER_VI)
	rm -rf $(NAME_CLI)
	make all -C ./source/libs/libft
	$(CC) $(CFLAGS) $(OBJ_CLI) $(LIBFT) $(LIBS) $(EFLAGS) -o $(NAME_CLI)

################################################################################
##############################  CLEAN  #########################################
################################################################################
# Erase all .o files and ./a.out

clean:
	make clean -C ./source/libs/libft
	rm -rf $(OBJ) $(OBJ_CLI)
	rm -rf ./a.out

################################################################################
##############################  FCLEAN  ########################################
################################################################################
# Erase all .o files and ./a.out and the binary

fclean: clean
	make fclean -C ./source/libs/libft
	rm -rf $(NAME) $(NAME_CLI)

################################################################################
##############################  RE  ############################################
################################################################################
# Erase all .o files and ./a.out and the binary and recompile

re: fclean all

################################################################################
##############################  PUSH  ##########################################
################################################################################
# Add all files, commit with a message and push

push:fclean
	git add .
	read -p "Message:" message; \
	git commit -m "$$message"; \
	git push

################################################################################
##############################  RUN  ###########################################
################################################################################
# Compile both binaries and run the server

run: all logvi
	./avengers_api

################################################################################
##############################  PHONY  #########################################
################################################################################
# Avoid conflicts with files named clean, fclean, re, push, run

.PHONY: all bonus clean fclean re push run

################################################################################
